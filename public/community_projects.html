<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renew Community Projects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons for cleaner vectors -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                // Mapped to the modern dark theme palette (Consistent across all screens)
                'primary-blue': '#0F172A', // Dark Slate Blue (Background)
                'primary-green': '#34D399', // Vibrant Emerald (Accent)
                'secondary-gray': '#94A3B8', // Muted Slate (Labels)
                'accent-red': '#F87171', // Soft Red (Danger/Logout)
                'accent-yellow': '#FBBF24', // Amber (Live Rate/Savings Accent)
                'neutral-white': '#F1F5F9', // Off-White (Text)
                'card-bg': '#1E293B', // Darker Card Background
                'rebot-blue': '#4F46E5', // Deep Indigo Blue for ReBot Button
              }
            }
          }
        }
    </script>
    <style>
        /* General Body Style (Consistent) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tw-colors-primary-blue);
            color: var(--tw-colors-neutral-white);
            padding-bottom: 5rem;
            min-height: 100vh;
        }

        /* Glassmorphism Panel Component (Consistent) */
        .glass-panel {
            background-color: rgba(30, 41, 59, 0.6); /* Use card-bg with high opacity */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); /* Deeper shadow */
        }
        
        /* Card Shadow/Hover Effect (Consistent) */
        .card-shadow {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, border-color 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        #map {
            width: 100%;
            height: 300px;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }


        /* --- Primary Tab Styling (Consistent) --- */
        .tab-button {
            transition: all 0.3s ease-in-out;
            font-weight: 500;
            color: var(--tw-colors-secondary-gray); /* Default text color */
        }

        .tab-button.active {
            font-weight: 700;
            color: var(--tw-colors-primary-blue); /* Dark text inside green tab */
            background-color: var(--tw-colors-primary-green);
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.4);
            border-radius: 9999px;
        }


        /* --- Project Card Styling --- */
        .project-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.3s;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.15); /* Match card-shadow base border */
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            border-color: var(--tw-colors-primary-green); /* Green border on hover */
        }

        .project-card.active {
            border: 2px solid var(--tw-colors-primary-green);
            transform: scale(1.01);
            animation: pulse-border 1.5s infinite ease-in-out;
        }
        
        /* Using primary-green color for pulse */
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.4); 
            }
            70% {
                box-shadow: 0 0 0 10px rgba(52, 211, 153, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(52, 211, 153, 0);
            }
        }

        /* --- Navigation Bar Styling (Consistent) --- */
        .nav-item {
            transition: all 0.2s ease-in-out;
            color: var(--tw-colors-secondary-gray); 
            transition: all 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        
        .nav-item.active {
            color: var(--tw-colors-neutral-white); /* Active text/icon color set to white */
            font-weight: 600;

            /* Green Glow Effect */
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.6), /* primary-green with opacity */
                        0 0 5px rgba(52, 211, 153, 0.4); 
            border-radius: 0.5rem;
            padding: 0.25rem 0; 
            margin: -0.25rem 0; 
        }

        /* Utility to hide the map placeholder */
        .map-ready .map-placeholder {
            display: none;
        }

        /* Always show the map placeholder if the map is not ready */
        #map:not(.map-ready) .map-placeholder {
            display: flex;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="flex-grow flex flex-col items-center py-10 px-4 bg-primary-blue">
        <main class="mx-auto max-w-4xl w-full">
            <header class="py-4 mb-8 text-center">
                <h1 class="text-4xl font-bold text-neutral-white">Community Hub</h1>
                <p class="text-sm text-secondary-gray mt-1">Connect with local projects and make a difference.</p>
            </header>

            <!-- Primary Tabs (Projects vs Leaderboards) -->
            <div class="flex p-1 mb-6 rounded-full max-w-sm mx-auto glass-panel">
                <a href="#" class="tab-button active flex-1 py-2 px-6 text-center text-sm rounded-full transition-all duration-300 ease-in-out">
                    Projects
                </a>
                <a href="community_leaderboard.html" class="tab-button flex-1 py-2 px-6 text-center text-sm rounded-full text-secondary-gray hover:text-primary-green transition-all duration-300 ease-in-out">
                    Leaderboards
                </a>
            </div>

            <div id="content-container">
                <div id="projects-view">
                    
                    <!-- Collective Impact Section -->
                    <section class="glass-panel p-4 md:p-6 mb-6 rounded-2xl card-shadow">
                        <h2 class="text-xl font-bold text-neutral-white mb-2">Collective Impact</h2>
                        <p class="text-secondary-gray text-sm leading-relaxed mb-2">
                            Together we have reduced <span id="co2-impact" class="font-bold text-primary-green">0</span> tons of CO2 emissions.
                        </p>
                        <p class="text-sm text-secondary-gray mb-4">
                            That's the equivalent of planting <span id="trees-impact" class="font-bold text-primary-green">0</span> trees.
                        </p>
                        <!-- Map Placeholder/Container -->
                        <div id="map" class="relative">
                            <!-- This is the message div, now dynamically hidden when map is ready -->
                            <div class="map-placeholder absolute inset-0 flex items-center justify-center text-center p-4 bg-card-bg bg-opacity-70 rounded-xl">
                                <p class="text-neutral-white text-sm md:text-base">
                                    Map is loading...<br>If it does not appear, check your console for Google Maps API errors.
                                </p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Project Cards Section -->
                    <section class="mb-6">
                        <h2 class="text-xl font-bold text-neutral-white mb-4">Community Projects</h2>
                        <div id="projects-container" class="flex overflow-x-auto gap-4 py-2 px-1">
                            <!-- Project cards will be rendered here by JavaScript -->
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Bar (Fixed Bottom) -->
    <div id="mobile-nav" class="fixed bottom-0 left-0 right-0 z-50 bg-white/5 backdrop-blur-md rounded-t-3xl shadow-lg border-t-2 border-white/10">
        <nav class="flex justify-around items-center h-16">
            <a href="home.html" class="flex flex-col items-center justify-center p-2 text-sm font-medium focus:outline-none text-secondary-gray hover:text-primary-green transition-colors" data-tab="home">
                <i data-lucide="home" class="h-6 w-6"></i>
                <span class="mt-1 text-xs">Home</span>
            </a>
            <a href="devices.html" class="flex flex-col items-center justify-center p-2 text-sm font-medium text-neutral-white focus:outline-none active transition-colors" data-tab="devices">
                <i data-lucide="plug" class="h-6 w-6"></i>
                <span class="mt-1 text-xs">Devices</span>
            </a>
            <a href="community.html" class="flex flex-col items-center justify-center p-2 text-sm font-medium text-secondary-gray hover:text-primary-green focus:outline-none transition-colors" data-tab="community">
                <i data-lucide="users" class="h-6 w-6"></i>
                <span class="mt-1 text-xs">Community</span>
            </a>
            <a href="savings.html" class="flex flex-col items-center justify-center p-2 text-sm font-medium text-secondary-gray hover:text-primary-green focus:outline-none transition-colors" data-tab="savings">
                <i data-lucide="trending-up" class="h-6 w-6"></i>
                <span class="mt-1 text-xs">Savings</span>
            </a>
        </nav>
    </div>
    
    <script>
        // Data for community projects with icons
        const projectsData = [
            {
                id: 'maynooth-primary-solar',
                name: 'Maynooth Primary School',
                description: 'Solar Panel Project',
                location: { lat: 53.3792, lng: -6.5912 },
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-primary-green"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`
            },
            {
                id: 'celbridge-community-wind',
                name: 'Celbridge Community',
                description: 'Community Wind Turbine',
                location: { lat: 53.3340, lng: -6.5410 },
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-primary-green"><path d="M12 2v10m-3-3l3-3m3 3l-3-3m0 0l-3 3m3 3l-3 3m0 0l3 3m3-3l-3 3"/><path d="M12 12L7 20"/></svg>`
            },
            {
                id: 'leixlip-library-insulation',
                name: 'Leixlip Library',
                description: 'Building Insulation Upgrade',
                location: { lat: 53.3762, lng: -6.4851 },
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-primary-green"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>`
            },
            {
                id: 'clane-sports-lighting',
                name: 'Clane Sports Centre',
                description: 'LED Lighting Installation',
                location: { lat: 53.2848, lng: -6.6853 },
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-primary-green"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/></svg>`
            },
            {
                id: 'kilcock-local-garden',
                name: 'Kilcock Local Allotment',
                description: 'Smart Irrigation System',
                location: { lat: 53.4078, lng: -6.6711 },
                icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-primary-green"><path d="M12 2.69l5.65 5.65A7.5 7.5 0 0 1 12 22 7.5 7.5 0 0 1 6.35 8.35L12 2.69z"/></svg>`
            }
        ];

        // Collective impact data
        const collectiveImpact = {
            co2Reduced: 1543.78, // in tonnes
            treesPlanted: 200
        };

        let map;
        let markers = [];
        let activeCardId = null;

        // --- DOM Elements ---
        const projectsContainer = document.getElementById('projects-container');
        const co2ImpactEl = document.getElementById('co2-impact');
        const treesImpactEl = document.getElementById('trees-impact');
        const mapElement = document.getElementById('map');


        // --- Map Functions ---
        async function loadGoogleMaps() {
            try {
                const response = await fetch('/api/maps-key');
                const { apiKey } = await response.json();
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initializeMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            } catch (error) {
                console.error('Failed to load Google Maps:', error);
                // Display an error message to the user
                if (mapElement) {
                    mapElement.innerHTML = '<p class="text-center text-red-500">Could not load map. Please try again later.</p>';
                }
            }
        }

        // CRITICAL: This function must be defined globally so the Maps script can call it.
        window.initializeMap = function() {
            // Check if Google Maps is loaded before trying to initialize
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API is not loaded yet.");
                return;
            }
            
            // Check if map is already initialized
            if (map) {
                return;
            }

            // Remove the placeholder message overlay
            mapElement.classList.add('map-ready');

            // Initialize the Google map
            const mapOptions = {
                center: { lat: 53.3792, lng: -6.5912 },
                zoom: 12,
                // Using a default map ID as 'DEMO_MAP_ID' may require configuration
                mapId: 'satellite', // Use a default style if mapId is not configured
            };
            map = new google.maps.Map(mapElement, mapOptions);
            
            renderMarkers(projectsData);
        }

        function renderMarkers(projects) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            projects.forEach(project => {
                const marker = new google.maps.Marker({
                    position: project.location,
                    map: map,
                    title: project.name,
                });
                
                const infowindow = new google.maps.InfoWindow({
                    content: `<b>${project.name}</b><br>${project.description}`,
                });

                marker.addListener("click", () => {
                    infowindow.open({
                        anchor: marker,
                        map,
                    });
                    highlightCard(project.id);
                });
                markers.push(marker);
            });
        }

        // --- Project Cards Functions ---
        function renderProjectCards(projects) {
            projectsContainer.innerHTML = '';
            if (projects.length === 0) {
                projectsContainer.innerHTML = `
                    <p class="text-center text-secondary-gray p-8">No projects found in this area.</p>
                `;
                return;
            }

            projects.forEach(project => {
                const card = document.createElement('div');
                card.id = `card-${project.id}`;
                // Simplified class names for Tailwind consistency
                card.className = `project-card glass-panel p-4 rounded-xl flex-shrink-0 w-64 hover:border-primary-green`;
                card.innerHTML = `
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="p-2 rounded-full bg-card-bg/70">
                           ${project.icon}
                        </div>
                        <h3 class="text-lg font-semibold text-neutral-white">${project.name}</h3>
                    </div>
                    <p class="text-sm text-secondary-gray">${project.description}</p>
                `;
                card.addEventListener('click', () => {
                    if (map) {
                        map.setCenter(project.location);
                        map.setZoom(15);
                        const marker = markers.find(m => m.title === project.name);
                        if (marker) {
                            new google.maps.InfoWindow({
                                content: `<b>${project.name}</b><br>${project.description}`,
                            }).open({
                                anchor: marker,
                                map,
                            });
                        }
                    } else {
                        console.warn("Map not initialized. Cannot pan.");
                    }
                    highlightCard(project.id);
                });
                projectsContainer.appendChild(card);
            });

            // Set the first card as active by default
            if (projects.length > 0) {
                highlightCard(projects[0].id);
            }
        }

        function highlightCard(id) {
            document.querySelectorAll('.project-card').forEach(card => card.classList.remove('active'));
            const newActiveCard = document.getElementById(`card-${id}`);
            if (newActiveCard) {
                newActiveCard.classList.add('active');
                activeCardId = id;
            }
        }

        // --- Collective Impact Functions ---
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.textContent = (progress * (end - start) + start).toFixed(obj.id === 'co2-impact' ? 2 : 0);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function updateCollectiveImpact() {
            animateValue(co2ImpactEl, 0, collectiveImpact.co2Reduced, 1500);
            animateValue(treesImpactEl, 0, collectiveImpact.treesPlanted, 1500);
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Render the cards and update impact data
            updateCollectiveImpact();
            renderProjectCards(projectsData);
            loadGoogleMaps();
        });

    </script>
</body>
</html>